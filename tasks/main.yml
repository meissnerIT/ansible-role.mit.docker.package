---

# # Variables
#
# compose
# https://docs.docker.com/compose/migrate/
#
# `docker-compose` has been replaced by Compose v2 via `docker compose`
# 
# * v1 installations: docker_compose_packages=docker-compose-plugin
# * v1 compatible: docker_compose_packages=docker-compose,docker-compose-plugin
# * v1 deprecated: docker_compose_version=1.29.2

# https://docs.docker.com/config/daemon/systemd/
# https://www.freedesktop.org/software/systemd/man/systemd.unit.html#Unit%20File%20Load%20Path

#20411: Deployment
# https://docs.docker.com/engine/install/debian/

- set_fact:
    docker_apt_repository: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
- name: Install apt-transport-https
  apt:
    pkg: apt-transport-https
- name: "Add apt gpg key for download.docker.com"
  copy:
    src: docker.gpg
    dest: /usr/share/keyrings/docker.gpg
- name: Enable apt repository
  apt_repository:
    repo: "{{ docker_apt_repository }}"
    state: present
  changed_when: no
- name: Install / update docker
  apt:
    pkg: docker-ce,docker-ce-cli,containerd.io
    update_cache: yes
    state: latest
# https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html
- name: Install compose (package)
  apt:
    name: "{{ docker_compose_packages }}"
  when: docker_compose_packages is defined
- name: Disable apt repository
  apt_repository:
    repo: "{{ docker_apt_repository }}"
    state: absent
  changed_when: no
- name: Add local-download.docker.com.list.disabled
  template:
    src: local-download.docker.com.list
    dest: /etc/apt/sources.list.d/local-download.docker.com.list.disabled

# https://docs.docker.com/config/daemon/systemd/#httphttps-proxy
# group_vars/proxy_required
- name: Set docker http proxy environment variables
  template:
    src: "http-proxy.conf"
    dest: /etc/systemd/system/docker.service.d/
  when: proxy_env is defined
  notify:
    - Reload systemd
    - Restart docker

- name: Set docker mtu
  # https://github.com/ParticleDecay/ansible-jsonpatch
  json_patch:
    src: /etc/docker/daemon.json
    operations:
      - op: add
        path: /mtu
        value: 1200
    pretty: yes
    create: yes
  when: docker_mtu is defined
  notify: restart docker

- name: Install docker compose (manually)
  include_tasks: docker-compose-manually.yml
  when: docker_compose_version is defined

